# ~/.config/fish/conf.d/infisical_auth.fish.tmpl

# 1. Machine Identity (Raspberry Pi Only)
{{- if eq .chezmoi.hostname "raspberrypi" }}
  {{- if (and .infisical .infisical.clientId) }}
  set -gx INFISICAL_CLIENT_ID "{{ .infisical.clientId }}"
  set -gx INFISICAL_CLIENT_SECRET "{{ .infisical.clientSecret }}"
  {{- end }}
{{- end }}

# 2. Universal Project ID
set -gx INFISICAL_PROJECT_ID "8ae0704f-ad44-4984-bbeb-64b61faa46b5"

# 3. Conditional API URL
# Raspberry Pi uses local loopback to bypass Hairpin NAT
{{- if eq .chezmoi.hostname "raspberrypi" }}
set -gx INFISICAL_API_URL "http://127.0.0.1:8081"
{{- else }}
# Mac-mini, mint-mini, and all others use the Tailnet address
set -gx INFISICAL_API_URL "https://secrets.cuttlefish-gorgon.ts.net"
{{- end }}

# 4. Load the secrets into the environment
# ONLY do this in interactive shells to avoid breaking SSH/AntiGravity/Automation
if status is-interactive
    if type -q infisical
        infisical export --format=unix | source
    end
end

# 5. Path Management
fish_add_path --prepend --move ~/.local/bin
